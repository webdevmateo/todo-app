<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Udacity Todos Goals</title>
  </head>
  <body>

    <div>
      <h1>Todo List</h1>
      <input type="text" id="todo" placeholder="Add Todo">
      <button id="todoBtn">Add Todo</button>
      <ul id="todos"></ul>
    </div>
    <div>
      <h1>Goals</h1>
      <input type="text" id="goal" placeholder="Add Goal">
      <button id="goalBtn">Add Goal</button>
      <ul id="goals"></ul>
    </div>
    <script type="text/javascript">
      //Library code

      const store = (function createStore (reducer) {
        //The store should have four parts
        //1. The state
        //2. Get the state
        //3. Listen to changes on the state
        //4. Update the state

        let state;
        let listeners = [];

        const getState = () => state;
        const subscribe = (listener) => {
          listeners.push(listener);
          return () => {
            listeners = listeners.filter((l) => l !== listener);
          }
        }

        const dispatch = (action) => {
          state = reducer(state, action);
          listeners.forEach((listener) => listener());
        }

        return {
          getState,
          subscribe,
          dispatch
        }
      })(app);

      //App code

      function addTodoAction (todo) {
        const ADD_TODO = 'ADD_TODO';
        return {
          type: ADD_TODO,
          todo,
        }
      }

      function removeTodoAction (id) {
        const REMOVE_TODO = 'REMOVE_TODO';
        return {
          type: REMOVE_TODO,
          id,
        }
      }

      function toggleTodoAction (id) {
        const TOGGLE_TODO = 'TOGGLE_TODO';
        return {
          type: TOGGLE_TODO,
          id,
        }
      }

      function addGoalAction (goal) {
        const ADD_GOAL = 'ADD_GOAL';
        return {
          type: ADD_GOAL,
          goal,
        }
      }

      function removeGoalAction (id) {
        const REMOVE_GOAL = 'REMOVE_GOAL';
        return {
          type: REMOVE_GOAL,
          id,
        }
      }

      function todos (state = [], action) {
        const ADD_TODO = 'ADD_TODO';
        const REMOVE_TODO = 'REMOVE_TODO';
        const TOGGLE_TODO = 'TOGGLE_TODO';
        switch (action.type) {
          case ADD_TODO:
            return state.concat([action.todo]);
          case REMOVE_TODO:
            return state.filter((todo) => todo.id !== action.id);
          case TOGGLE_TODO:
            return state.map((todo) => todo.id !== action.id ? todo : Object.assign({}, todo, {complete: !todo.complete}));
          default:
            return state;
        }
      }

      function goals(state = [], action) {
        const ADD_GOAL = 'ADD_GOAL';
        const REMOVE_GOAL = 'REMOVE_GOAL';
        switch (action.type) {
          case ADD_GOAL:
            return state.concat([action.goal]);
          case REMOVE_GOAL:
            return state.filter((goal) => goal.id !== action.id);
          default:
            return state;
        }
      }

      function app (state = {}, action) {
        return {
          todos: todos(state.todos, action),
          goals: goals(state.goals, action)
        }
      }

      //DOM Code

      (function addTodo () {
        const todoBtn = document.getElementById('todoBtn');
        let id = 0;
        todoBtn.addEventListener('click', () => {
          const input = document.getElementById('todo');
          if (input.value) {
            store.dispatch(addTodoAction({
              id,
              name: input.value,
              complete: false,
            }));
            id += 1;
            input.value = '';
          }
        });
      })();

      (function addGoal () {
        const goalBtn = document.getElementById('goalBtn');
        let id = 0;
        goalBtn.addEventListener('click', () => {
          const input = document.getElementById('goal');
          if (input.value) {
            store.dispatch(addGoalAction({
              id,
              name: input.value,
            }));
            id += 1;
            input.value = '';
          }
        });
      })();

      function populateTodoList (todo) {
        const node = document.createElement('li');
        const text = document.createTextNode(todo.name);
        node.appendChild(text);
        const list = document.getElementById('todos');
        list.appendChild(node);
        node.style.textDecoration = todo.complete ? 'line-through' : 'none';
        node.addEventListener('click', () => {
          store.dispatch(toggleTodoAction(todo.id));
        });
      }

      function populateGoalList (goal) {
        const node = document.createElement('li');
        const text = document.createTextNode(goal.name);
        node.appendChild(text);
        const list = document.getElementById('goals');
        list.appendChild(node);
      }

      store.subscribe(() => {
          const {todos, goals} = store.getState();

          document.getElementById('todos').innerHTML = '';
          document.getElementById('goals').innerHTML = '';

          todos.forEach(populateTodoList);
          goals.forEach(populateGoalList);

      });

      store.dispatch(removeTodoAction(1));

      store.dispatch(toggleTodoAction(0));

      store.dispatch(removeGoalAction(0));
    </script>
  </body>
</html>
